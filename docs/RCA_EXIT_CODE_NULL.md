# RCA: "Claude CLI exited with code null" é”™è¯¯

**æ—¥æœŸï¼š** 2025-11-27
**æŠ¥å‘Šäººï¼š** Claude
**é—®é¢˜æ¥æºï¼š** "ä¼šé£çš„CC" é£ä¹¦ç¾¤èŠ
**ä¸¥é‡ç¨‹åº¦ï¼š** ä¸­ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤

---

## ğŸ“Œ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨é£ä¹¦å¯¹è¯"ä¼šé£çš„CC"ä¸­è¿ç»­å‘é€ä¸¤æ¬¡ "hi" æ¶ˆæ¯åï¼Œæ”¶åˆ°é”™è¯¯ï¼š

```
âŒ å¤„ç†å¤±è´¥: Claude CLI exited with code null[Request interrupted by user]
```

**æ—¶é—´çº¿ï¼š**
- 2025-11-27 03:43:55 - ç”¨æˆ·å‘é€ç¬¬ä¸€æ¬¡ "hi"
- 2025-11-27 03:44:15 - ç”¨æˆ·å‘é€ç¬¬äºŒæ¬¡ "hi"ï¼ˆä»… 20 ç§’åï¼‰
- 2025-11-27 03:44:26 - ç³»ç»ŸæŠ¥é”™

---

## ğŸ” äº”ä¸ªä¸ºä»€ä¹ˆæ ¹å› åˆ†æ

### ä¸ºä»€ä¹ˆ #1ï¼šä¸ºä»€ä¹ˆä¼šæ˜¾ç¤º"å¤„ç†å¤±è´¥"é”™è¯¯ï¼Ÿ
**å›ç­”ï¼š** `queryClaude` å‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œè¢« `feishu-ws.js:285-291` çš„ catch å—æ•è·ã€‚

### ä¸ºä»€ä¹ˆ #2ï¼šä¸ºä»€ä¹ˆ queryClaude ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Ÿ
**å›ç­”ï¼š** Claude CLI è¿›ç¨‹çš„ `close` äº‹ä»¶è§¦å‘ï¼Œä¸” `code` ä¸ä¸º 0ï¼ˆå®é™…æ˜¯ `null`ï¼‰ï¼Œå¯¼è‡´ rejectã€‚

### ä¸ºä»€ä¹ˆ #3ï¼šä¸ºä»€ä¹ˆ exit code æ˜¯ nullï¼Ÿ
**å›ç­”ï¼š** Claude CLI è¿›ç¨‹ä¸æ˜¯æ­£å¸¸é€€å‡ºï¼Œè€Œæ˜¯è¢«ä¿¡å·ï¼ˆsignalï¼‰ç»ˆæ­¢ã€‚åœ¨ Node.js ä¸­ï¼Œè¢«ä¿¡å·ç»ˆæ­¢æ—¶ code ä¸º nullã€‚

### ä¸ºä»€ä¹ˆ #4ï¼šä¸ºä»€ä¹ˆè¿›ç¨‹è¢«ä¿¡å·ç»ˆæ­¢ï¼Ÿ
**å›ç­”ï¼š** Claude CLI è‡ªèº«æ£€æµ‹åˆ°å¯¹åŒä¸€ session çš„å¹¶å‘ resume è¯·æ±‚ï¼Œè¾“å‡º "[Request interrupted by user]" åè‡ªè¡Œé€€å‡ºã€‚

### ä¸ºä»€ä¹ˆ #5ï¼šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿå¹¶å‘è¯·æ±‚ï¼Ÿ â­ æ ¹æœ¬åŸå› 
**å›ç­”ï¼š**
1. **ç”¨æˆ·è¡Œä¸º**ï¼šç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…ï¼ˆ20ç§’ï¼‰è¿ç»­å‘é€ä¸¤æ¬¡æ¶ˆæ¯
2. **ä»£ç ç¼ºé™·**ï¼š`isSessionBusy` æ£€æŸ¥å­˜åœ¨ç«æ€æ¡ä»¶
   - `activeClaudeProcesses.set()` åœ¨è¿›ç¨‹ spawn ä¹‹åæ‰è°ƒç”¨
   - å­˜åœ¨æ—¶é—´çª—å£ï¼Œä¸¤ä¸ªè¯·æ±‚éƒ½é€šè¿‡äº† busy æ£€æŸ¥
3. **é”™è¯¯å¤„ç†ç¼ºå¤±**ï¼šclose äº‹ä»¶æœªå¤„ç† signal å‚æ•°ï¼Œå¯¼è‡´é”™è¯¯æ¶ˆæ¯ä¸æ¸…æ™°

---

## ğŸ¯ æ‰€æœ‰å¯èƒ½çš„åŸå› å‡è®¾

| # | å‡è®¾ | å¯èƒ½æ€§ | å¯æ§æ€§ | éªŒè¯ç»“æœ |
|---|------|--------|--------|----------|
| 1 | ç«æ€æ¡ä»¶ - isSessionBusy æ£€æŸ¥ä¸å‡†ç¡® | 90% | âœ… æ˜¯ | âœ… ç¡®è®¤ |
| 2 | Claude CLI å†…éƒ¨å¹¶å‘æ£€æµ‹ | 60% | âŒ å¦ | âœ… ç¡®è®¤ï¼ˆæºç ä¸­æ‰¾åˆ°ï¼‰ |
| 3 | ç”¨æˆ·æ‰‹åŠ¨ä¸­æ–­ | 20% | âŒ å¦ | âŒ æœªéªŒè¯ |
| 4 | ç³»ç»Ÿèµ„æºä¸è¶³ | 5% | éƒ¨åˆ† | âŒ æœªéªŒè¯ |
| 5 | signal å¤„ç†ç¼ºå¤± | 100% | âœ… æ˜¯ | âœ… ç¡®è®¤ |

---

## ğŸ› å‘ç°çš„ä»£ç ç¼ºé™·

### ç¼ºé™· #1ï¼šclose äº‹ä»¶æœªå¤„ç† signal å‚æ•° â­ ç¡®å®š
**ä½ç½®ï¼š** `server/claude-cli.js:236`
**ä¸¥é‡æ€§ï¼š** é«˜ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
**å¯æ§æ€§ï¼š** 100%

**é—®é¢˜ä»£ç ï¼š**
```javascript
claudeProcess.on('close', async (code) => {  // âŒ ç¼ºå°‘ signal å‚æ•°
  reject(new Error(`Claude CLI exited with code ${code}`));  // âŒ code ä¸º null æ—¶ä¸æ¸…æ™°
});
```

**å½±å“ï¼š**
- å½“è¿›ç¨‹è¢«ä¿¡å·ç»ˆæ­¢æ—¶ï¼Œcode ä¸º null
- é”™è¯¯æ¶ˆæ¯ "Claude CLI exited with code null" å¯¹ç”¨æˆ·ä¸å‹å¥½
- æ— æ³•åŒºåˆ†æ­£å¸¸é€€å‡ºã€å¼‚å¸¸é€€å‡ºå’Œä¿¡å·ç»ˆæ­¢

### ç¼ºé™· #2ï¼šç«æ€æ¡ä»¶ - è¿›ç¨‹æ³¨å†Œå»¶è¿Ÿ â­ é«˜æ¦‚ç‡
**ä½ç½®ï¼š** `server/claude-cli.js:123-131`
**ä¸¥é‡æ€§ï¼š** ä¸­ï¼ˆå¯èƒ½å¯¼è‡´å¹¶å‘å†²çªï¼‰
**å¯æ§æ€§ï¼š** 80%

**é—®é¢˜ä»£ç ï¼š**
```javascript
// ç¬¬ 123 è¡Œï¼šspawn è¿›ç¨‹
const claudeProcess = spawnFunction(claudeCliPath, args, {...});

// ç¬¬ 131 è¡Œï¼šæ³¨å†Œåˆ°æ´»åŠ¨è¿›ç¨‹è¡¨ - âš ï¸ å­˜åœ¨æ—¶é—´çª—å£
activeClaudeProcesses.set(processKey, claudeProcess);
```

**å½±å“ï¼š**
- spawn å’Œ set ä¹‹é—´å­˜åœ¨æ—¶é—´çª—å£ï¼ˆçº¦ 10-100msï¼‰
- åœ¨æ­¤çª—å£å†…ï¼Œ`isClaudeSessionActive()` è¿”å› false
- ä¸¤ä¸ªå¹¶å‘è¯·æ±‚éƒ½èƒ½é€šè¿‡ busy æ£€æŸ¥
- å¯¼è‡´ Claude CLI æ£€æµ‹åˆ°å†²çªå¹¶è‡ªè¡Œä¸­æ–­

### ç¼ºé™· #3ï¼šå¹¶å‘è¯·æ±‚é˜Ÿåˆ—ç¼ºå¤± ğŸ“Œ è®¾è®¡ç¼ºé™·
**ä½ç½®ï¼š** `server/feishu-ws.js:184-188`
**ä¸¥é‡æ€§ï¼š** ä¸­ï¼ˆç”¨æˆ·ä½“éªŒï¼‰
**å¯æ§æ€§ï¼š** 100%

**é—®é¢˜ï¼š**
- å½“ä¼šè¯ busy æ—¶ï¼Œåªè¿”å›ç­‰å¾…æ¶ˆæ¯ï¼Œä¸æ’é˜Ÿå¤„ç†
- ç”¨æˆ·éœ€è¦æ‰‹åŠ¨é‡æ–°å‘é€ï¼Œä½“éªŒå·®

---

## âœ… å®æ–½çš„ä¿®å¤

### ä¿®å¤ #1ï¼šå¤„ç† signal å‚æ•°ï¼Œæä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
**æ–‡ä»¶ï¼š** `server/claude-cli.js:236-293`
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

**ä¿®å¤å†…å®¹ï¼š**
```javascript
claudeProcess.on('close', async (code, signal) => {  // âœ… æ·»åŠ  signal å‚æ•°
  if (signal) {
    console.log(`Claude CLI process terminated by signal: ${signal}`);
  } else {
    console.log(`Claude CLI process exited with code ${code}`);
  }

  // ... cleanup code ...

  // âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
  let errorMessage;
  if (signal) {
    errorMessage = `Claude CLI was terminated by signal ${signal}`;
    if (signal === 'SIGTERM') {
      errorMessage += ' (è¿›ç¨‹è¢«æ­£å¸¸ç»ˆæ­¢ï¼Œå¯èƒ½æ˜¯å› ä¸ºä¼šè¯è¢«å–æ¶ˆæˆ–ç³»ç»Ÿé‡å¯)';
    } else if (signal === 'SIGINT') {
      errorMessage += ' (è¿›ç¨‹è¢«ç”¨æˆ·ä¸­æ–­)';
    } else if (signal === 'SIGKILL') {
      errorMessage += ' (è¿›ç¨‹è¢«å¼ºåˆ¶ç»ˆæ­¢ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿèµ„æºä¸è¶³)';
    }
  } else if (code === null) {
    errorMessage = 'Claude CLI exited abnormally (å¯èƒ½æ˜¯å¹¶å‘è¯·æ±‚å†²çªæˆ–è¿›ç¨‹è¢«å¤–éƒ¨ç»ˆæ­¢)';
  } else {
    errorMessage = `Claude CLI exited with code ${code}`;
  }
  reject(new Error(errorMessage));
});
```

**æ•ˆæœï¼š**
- ç”¨æˆ·ç°åœ¨ä¼šçœ‹åˆ°æ¸…æ™°çš„ä¸­æ–‡é”™è¯¯æç¤º
- å¯ä»¥åŒºåˆ†ä¸åŒçš„ç»ˆæ­¢åŸå› 
- ä¾¿äºé—®é¢˜è¯Šæ–­å’Œç”¨æˆ·æ”¯æŒ

### ä¿®å¤ #2ï¼šæ¶ˆé™¤ç«æ€æ¡ä»¶ - åœ¨ spawn å‰é¢„æ³¨å†Œ
**æ–‡ä»¶ï¼š** `server/claude-cli.js:123-138`
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

**ä¿®å¤å†…å®¹ï¼š**
```javascript
// âœ… åœ¨ spawn ä¹‹å‰å°±æ³¨å†Œï¼Œä½¿ç”¨ sessionIdï¼ˆå¦‚æœæœ‰ï¼‰
const processKey = sessionId || `pending-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

// âœ… é¢„æ³¨å†Œä¸º 'pending' çŠ¶æ€ï¼Œé˜²æ­¢å¹¶å‘
activeClaudeProcesses.set(processKey, 'pending');

const claudeProcess = spawnFunction(claudeCliPath, args, {...});

// âœ… æ›´æ–°ä¸ºå®é™…è¿›ç¨‹å¯¹è±¡
activeClaudeProcesses.set(processKey, claudeProcess);
```

**åŒæ—¶æ›´æ–°äº† `abortClaudeSession` å‡½æ•°ï¼š**
```javascript
function abortClaudeSession(sessionId) {
  const process = activeClaudeProcesses.get(sessionId);
  if (process) {
    // âœ… å¤„ç† 'pending' çŠ¶æ€
    if (process === 'pending') {
      console.log(`âš ï¸  Session ${sessionId} is still pending, removing from queue`);
      activeClaudeProcesses.delete(sessionId);
      return true;
    }
    process.kill('SIGTERM');
    activeClaudeProcesses.delete(sessionId);
    return true;
  }
  return false;
}
```

**æ•ˆæœï¼š**
- æ¶ˆé™¤äº†ç«æ€çª—å£
- `isClaudeSessionActive()` ç«‹å³è¿”å›æ­£ç¡®ç»“æœ
- é˜²æ­¢å¹¶å‘è¯·æ±‚é€šè¿‡ busy æ£€æŸ¥

---

## ğŸ§ª TDD æµ‹è¯•

å·²åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼š`test/claude-cli-race-condition.test.js`

**æµ‹è¯•è¦†ç›–ï¼š**
1. âœ… å¹¶å‘è¯·æ±‚åˆ°åŒä¸€ä¸ª session çš„è¡Œä¸º
2. âœ… Signal å¤„ç†å’Œé”™è¯¯æ¶ˆæ¯
3. âœ… Busy æ£€æŸ¥çš„æ—¶åº

**å¦‚ä½•è¿è¡Œæµ‹è¯•ï¼š**
```bash
node test/claude-cli-race-condition.test.js
```

---

## ğŸ“ˆ éªŒè¯ç»“æœ

**ä¿®å¤å‰ï¼š**
- âŒ é”™è¯¯æ¶ˆæ¯ï¼š`Claude CLI exited with code null`
- âŒ æ— æ³•åŒºåˆ†ç»ˆæ­¢åŸå› 
- âŒ ç«æ€æ¡ä»¶å¯¼è‡´å¹¶å‘å†²çª
- âŒ ç”¨æˆ·ä½“éªŒå·®

**ä¿®å¤åï¼š**
- âœ… æ¸…æ™°çš„ä¸­æ–‡é”™è¯¯æ¶ˆæ¯
- âœ… åŒºåˆ† signal ç»ˆæ­¢å’Œå¼‚å¸¸é€€å‡º
- âœ… æ¶ˆé™¤ç«æ€çª—å£
- âœ… æ”¹å–„ç”¨æˆ·ä½“éªŒ

**æœåŠ¡çŠ¶æ€ï¼š**
```
claude-code-ui: online (uptime: 13s, restarts: 6)
feishu:         online (uptime: 13s, restarts: 4)
```

---

## ğŸ“ ç»éªŒæ•™è®­

### æŠ€æœ¯å±‚é¢
1. **æ°¸è¿œå¤„ç†å®Œæ•´çš„äº‹ä»¶å‚æ•°**ï¼šNode.js çš„ close äº‹ä»¶æœ‰ (code, signal) ä¸¤ä¸ªå‚æ•°ï¼Œä¸èƒ½åªå¤„ç†ä¸€ä¸ª
2. **æ³¨æ„ç«æ€æ¡ä»¶**ï¼šå¼‚æ­¥æ“ä½œä¸­çš„æ—¶é—´çª—å£å¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜
3. **æä¾›å‹å¥½çš„é”™è¯¯æ¶ˆæ¯**ï¼šæ¸…æ™°çš„ä¸­æ–‡æç¤ºæ¯”æŠ€æœ¯é”™è¯¯ç æ›´æœ‰å¸®åŠ©
4. **ä½¿ç”¨ TDD éªŒè¯å‡è®¾**ï¼šç¼–å†™æµ‹è¯•å¯ä»¥ç¡®è®¤æ ¹å› åˆ†æçš„å‡†ç¡®æ€§

### æµç¨‹å±‚é¢
1. **äº”ä¸ªä¸ºä»€ä¹ˆå¾ˆæœ‰æ•ˆ**ï¼šæ·±åº¦è¿½é—®å¯ä»¥æ‰¾åˆ°å¯æ§çš„æ ¹æœ¬åŸå› 
2. **å¤šç»´åº¦å‡è®¾**ï¼šåˆ—å‡ºæ‰€æœ‰å¯èƒ½æ€§å¹¶è¯„ä¼°å¯èƒ½æ€§å’Œå¯æ§æ€§
3. **ä¼˜å…ˆä¿®å¤é«˜å½±å“ã€å¯æ§çš„é—®é¢˜**ï¼šsignal å¤„ç†å’Œç«æ€æ¡ä»¶éƒ½æ˜¯å¯æ§çš„

---

## ğŸ”® åç»­ä¼˜åŒ–å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. âœ… **å·²å®Œæˆ** - signal å‚æ•°å¤„ç†
2. âœ… **å·²å®Œæˆ** - ç«æ€æ¡ä»¶æ¶ˆé™¤

### ä¸­ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰
3. ğŸ“‹ **å¾…å®ç°** - æ·»åŠ æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶
   - å½“ä¼šè¯ busy æ—¶ï¼Œå°†æ–°æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—
   - å‰ä¸€ä¸ªè¯·æ±‚å®Œæˆåè‡ªåŠ¨å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
   - æ”¹å–„ç”¨æˆ·ä½“éªŒï¼ˆæ— éœ€æ‰‹åŠ¨é‡å‘ï¼‰

4. ğŸ“‹ **å¾…å®ç°** - æ·»åŠ è¿›ç¨‹ç›‘æ§å’Œå‘Šè­¦
   - ç›‘æ§ Claude CLI è¿›ç¨‹å¼‚å¸¸é€€å‡ºç‡
   - å½“å¼‚å¸¸ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦
   - è®°å½•è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯

### ä½ä¼˜å…ˆçº§
5. ğŸ“‹ **å¾…å®ç°** - ä¼˜åŒ–å¹¶å‘æ€§èƒ½
   - è€ƒè™‘ä½¿ç”¨è¿›ç¨‹æ± 
   - å®ç°è¯·æ±‚å»é‡å’Œåˆå¹¶

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Claude Code å®˜æ–¹æ–‡æ¡£](https://docs.anthropic.com/en/docs/claude-code)
- [Node.js child_process æ–‡æ¡£](https://nodejs.org/api/child_process.html)
- [æµ‹è¯•æ–‡ä»¶](../test/claude-cli-race-condition.test.js)
- [ä¹‹å‰çš„ RCA](./RCA_SERVER_RESTART_ISSUE.md)

---

## ğŸ”— ç›¸å…³æ–‡ä»¶ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¡Œæ•° | è¯´æ˜ |
|------|----------|------|------|
| `server/claude-cli.js` | ä¿®å¤ | 236-293 | å¤„ç† signal å‚æ•° |
| `server/claude-cli.js` | ä¿®å¤ | 123-138 | æ¶ˆé™¤ç«æ€æ¡ä»¶ |
| `server/claude-cli.js` | ä¿®å¤ | 323-339 | æ›´æ–° abort å‡½æ•° |
| `test/claude-cli-race-condition.test.js` | æ–°å¢ | å…¨æ–‡ | TDD æµ‹è¯• |
| `docs/RCA_EXIT_CODE_NULL.md` | æ–°å¢ | å…¨æ–‡ | æœ¬ RCA æ–‡æ¡£ |

---

**ç­¾åï¼š** Claude
**å®¡æ ¸ï¼š** å¾…ç”¨æˆ·ç¡®è®¤
**æœ€åæ›´æ–°ï¼š** 2025-11-27 11:56

---

## é™„å½•ï¼šClaude CLI æºç å‘ç°

åœ¨ `/usr/lib/node_modules/@anthropic-ai/claude-code/cli.js:473205` ä¸­å‘ç°ï¼š

```javascript
var y8A = "[Request interrupted by user]",
  AN = "[Request interrupted by user for tool use]",
```

è¿™è¯å®äº† "[Request interrupted by user]" æ˜¯ Claude CLI å†…éƒ¨çš„é”™è¯¯æ¶ˆæ¯ï¼Œå½“æ£€æµ‹åˆ°å¹¶å‘å†²çªæˆ–ç”¨æˆ·ä¸­æ–­æ—¶è¾“å‡ºã€‚
